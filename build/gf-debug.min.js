/**
 * @license
 * GrapeFruit Debug Plugin - v0.0.1
 * Copyright (c) 2013, Chad Engler
 * https://github.com/grapefruitjs/gf-debug
 *
 * Compiled: 2013-07-31
 *
 * GrapeFruit Debug Plugin is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license.php
 */
!function(window){var document=window.document,d={version:"0.0.1",gfVersion:"0.0.x"};gf.plugin.register(d,"debug"),gf.debug.show=function(game){if(!(game&&game instanceof gf.Game))throw"Please pass a game instance to gf.debug.show!";if(this.game)throw"Already debugging a game instance!";this.game=game,this.game.on("beforetick",this._beforeTick.bind(this)),this.game.on("aftertick",this._afterTick.bind(this)),this.panels={world:new gf.debug.WorldPanel(game),sprites:new gf.debug.SpritesPanel(game),gamepad:new gf.debug.GamepadPanel(game),performance:new gf.debug.PerformancePanel(game)},this.logSpriteCount=!1,document.body.appendChild(this.createElement()),this.bindEvents()},gf.debug.logEvent=function(name){this.panels&&this.panels.performance&&this.panels.performance.logEvent(name)},gf.debug.bindEvents=function(){var activePanel,self=this;this.ui.bindDelegate(this._bar,"click","gf_debug_menu_item",function(e){var panel=self.panels[e.target.className.replace(/gf_debug_menu_item|active/g,"").trim()];if(panel){if(activePanel&&(activePanel.toggle(),self.ui.removeClass(activePanel._menuItem,"active"),activePanel.name===panel.name))return activePanel=null,void 0;self.ui.addClass(e.target,"active"),panel.toggle(),activePanel=panel}})},gf.debug.createElement=function(){var c=this._container=document.createElement("div"),bar=this._bar=document.createElement("div");this.ui.addClass(c,"gf_debug"),c.appendChild(bar),this.ui.addClass(bar,"gf_debug_menu"),bar.appendChild(this.createMenuHead()),bar.appendChild(this.createMenuStats());for(var p in this.panels)bar.appendChild(this.panels[p].createMenuElement()),c.appendChild(this.panels[p].createPanelElement());return c},gf.debug.createMenuHead=function(){var div=document.createElement("div");return this.ui.addClass(div,"gf_debug_menu_item gf_debug_head"),this.ui.setText(div,"Gf Debug:"),div},gf.debug.createMenuStats=function(){this._stats={};var div=document.createElement("div"),fps=this._stats.fps=document.createElement("div"),ms=this._stats.ms=document.createElement("div"),spr=this._stats.spr=document.createElement("div");return this.ui.addClass(div,"gf_debug_menu_item gf_debug_stats"),this.ui.addClass(ms,"gf_debug_stats_item ms"),this.ui.setHtml(ms,"<span>0</span> ms"),div.appendChild(ms),this.ui.addClass(fps,"gf_debug_stats_item fps"),this.ui.setHtml(fps,"<span>0</span> fps"),div.appendChild(fps),this.ui.addClass(spr,"gf_debug_stats_item spr"),this.ui.setHtml(spr,"<span>0</span> sprites"),div.appendChild(spr),div},gf.debug.timer=window.performance&&window.performance.now?window.performance:Date,gf.debug._beforeTick=function(){this._tickStart=this.timer.now()},gf.debug._afterTick=function(){this.statsTick(),this.panels.performance.tick(),this.panels.gamepad.tick()},gf.debug.statsTick=function(){this._tickEnd=this.timer.now();var ms=this._tickEnd-this._tickStart,fps=1e3/ms;fps=fps>60?60:fps,this.ui.setText(this._stats.ms.firstElementChild,ms.toFixed(2)),this.ui.setText(this._stats.fps.firstElementChild,fps.toFixed(2))},setInterval(function(){if(gf.debug._stats&&gf.debug._stats.spr){for(var c=0,s=gf.debug.game.activeState,wld=s.world,cam=s.camera;wld;)c++,wld=wld._iNext;for(;cam;)c++,cam=cam._iNext;gf.debug.ui.setText(gf.debug._stats.spr.firstElementChild,c),gf.debug.logSpriteCount&&gf.debug.logEvent("debug_count_sprites")}},1e3),gf.debug.Panel=function(game){this.game=game,this.name="",this.title=""},gf.inherits(gf.debug.Panel,Object,{createPanelElement:function(){var div=this._panel=document.createElement("div");return gf.debug.ui.addClass(div,"gf_debug_panel"),div},createMenuElement:function(){var div=this._menuItem=document.createElement("div");return gf.debug.ui.addClass(div,"gf_debug_menu_item "+this.name),gf.debug.ui.setText(div,this.title),div},toggle:function(){"block"===this._panel.style.display?this.hide():this.show()},show:function(){gf.debug.ui.setStyle(this._panel,"display","block")},hide:function(){gf.debug.ui.setStyle(this._panel,"display","none")}}),gf.debug.GamepadPanel=function(game){gf.debug.Panel.call(this,game),this.name="gamepad",this.title="Gamepad"},gf.inherits(gf.debug.GamepadPanel,gf.debug.Panel,{createPanelElement:function(){var div=gf.debug.Panel.prototype.createPanelElement.call(this);return gf.debug.ui.setText(div,"a gamepad image that shows the current gamepad state"),div},tick:function(){}}),gf.debug.PerformancePanel=function(game){gf.debug.Panel.call(this,game),this.name="performance",this.title="Performance",this.eventQueue=[]},gf.inherits(gf.debug.PerformancePanel,gf.debug.Panel,{createPanelElement:function(){var div=gf.debug.Panel.prototype.createPanelElement.call(this);return this.graph=new gf.debug.Graph(div,window.innerWidth,200,{input:"rgba(80, 80, 80, 1)",camera:"rgba(80, 80, 220, 1)",physics:"rgba(80, 220, 80, 1)",draw:"rgba(220, 80, 80, 1)",event:"rgba(200, 200, 200, 0.6)"}),this.graph.max=100,div},tick:function(){var t=this.game.timings,o={input:t.inputEnd-t.inputStart,camera:t.cameraEnd-t.cameraStart,phys:t.physicsEnd-t.physicsStart,draw:t.renderEnd-t.renderStart},evt=this.eventQueue.shift();evt&&(o.event=evt),this.graph.addData(o)},logEvent:function(name){this.eventQueue.push(name)}}),gf.debug.SpritesPanel=function(game){gf.debug.Panel.call(this,game),this.name="sprites",this.title="Sprites"},gf.inherits(gf.debug.SpritesPanel,gf.debug.Panel,{createPanelElement:function(){var div=gf.debug.Panel.prototype.createPanelElement.call(this),col=document.createElement("div");return gf.debug.ui.addClass(col,"checkbox"),gf.debug.ui.setHtml(col,'<input type="checkbox" value="None" id="gf_debug_toggleCollisions" class="gf_debug_toggleCollisions" name="check" /><label for="gf_debug_toggleCollisions"></label><span>Show sprite colliders</span>'),gf.debug.ui.bindDelegate(col,"click","gf_debug_toggleCollisions",this.toggleCollisions.bind(this),"input"),div.appendChild(col),div},toggleCollisions:function(){for(var obj=this.game.stage,style={color:16720418,sensor:{color:2293538}},show=!this.showing;obj;)obj.showPhysics&&(show?obj.showPhysics(style):obj.hidePhysics()),obj=obj._iNext;this.game.world._showPhysics=this.showing=show}}),gf.debug.WorldPanel=function(game){gf.debug.Panel.call(this,game),this.name="world",this.title="World"},gf.inherits(gf.debug.WorldPanel,gf.debug.Panel,{createPanelElement:function(){var div=gf.debug.Panel.prototype.createPanelElement.call(this);return gf.debug.ui.setText(div,"A minimap of the world, outline your current viewport, stats about the world"),div}}),gf.debug.Graph=function(container,width,height,dataStyles){this.canvas=document.createElement("canvas"),this.canvas.width=width,this.canvas.height=height,container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.label="ms",this.labelPrecision=0,this.labelStyle="rgba(200, 200, 200, 0.6)",this.max=50,this.dataLineWidth=1,this.padding=5,this.keySize=80,this.data=[],this.styles=dataStyles||{},this.styles._default||(this.styles._default="red"),this.styles.event||(this.styles.event="gray")},gf.inherits(gf.debug.Graph,Object,{addData:function(values){this.data.push(values),this.data.length>(this.canvas.width-this.keySize)/this.dataLineWidth&&this.data.shift(),this.redraw()},redraw:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawBg(),this.drawKey(),this.drawData()},drawBg:function(){var ctx=this.ctx,minX=this.keySize,maxX=this.canvas.width,maxY=this.canvas.height,step=maxY/3;ctx.strokeStyle=ctx.fillStyle=this.labelStyle,ctx.beginPath(),ctx.moveTo(minX,step),ctx.lineTo(maxX,step),ctx.stroke(),ctx.beginPath(),ctx.moveTo(minX,2*step),ctx.lineTo(maxX,2*step),ctx.stroke(),ctx.beginPath(),ctx.moveTo(minX,maxY),ctx.lineTo(maxX,maxY),ctx.stroke(),ctx.fillText((2*(this.max/3)).toFixed(this.labelPrecision)+this.label,minX+this.padding,step-this.padding),ctx.fillText((this.max/3).toFixed(this.labelPrecision)+this.label,minX+this.padding,2*step-this.padding)},drawKey:function(){var ctx=this.ctx,i=0,box=10,pad=this.padding,lbl=this.labelStyle;for(var k in this.styles){var style=this.styles[k],y=box*i+pad*(i+1);ctx.fillStyle=style,ctx.fillRect(pad,y,box,box),ctx.fillStyle=lbl,ctx.fillText(k,pad+box+pad,y+box),i++}},drawData:function(){for(var ctx=this.ctx,maxX=this.canvas.width,maxY=this.canvas.height,lw=this.dataLineWidth,len=this.data.length,i=len-1;i>-1;--i){var v,step,vals=this.data[i],x=maxX-(len-i)*lw,y=maxY;for(var k in vals)ctx.beginPath(),ctx.strokeStyle=ctx.fillStyle=this.styles[k]||this.styles._default,ctx.lineWidth=lw,v=vals[k],"event"===k?(ctx.moveTo(x,maxY),ctx.lineTo(x,0),ctx.fillText(v,x+this.padding,2*this.padding)):(step=v/this.max*maxY,step=0>step?0:step,ctx.moveTo(x,y),ctx.lineTo(x,y-=step)),ctx.stroke()}}}),gf.debug.ui={bindDelegate:function(dom,evt,cls,fn,name){name=name?name.toUpperCase():"DIV",dom.addEventListener(evt,function(e){if(e.target&&e.target.nodeName.toUpperCase()===name){var classes=e.target.className.split(" ");classes&&-1!==classes.indexOf(cls)&&fn&&fn(e)}})},removeClass:function(dom,cls){var classes=dom.className.split(" "),i=classes.indexOf(cls);-1!==i&&(classes.splice(i,1),dom.className=classes.join(" ").trim())},addClass:function(dom,cls){var classes=dom.className.split(" ");classes.push(cls),dom.className=classes.join(" ").trim()},setText:function(dom,txt){dom.textContent=txt},setHtml:function(dom,html){dom.innerHTML=html},setStyle:function(dom,style,value){if("string"==typeof style)dom.style[style]=value;else for(var key in style)dom.style[key]=style[key]}}}(window);