/**
 * @license
 * GrapeFruit Debug Plugin - v0.0.1
 * Copyright (c) 2013, Chad Engler
 * https://github.com/grapefruitjs/gf-debug
 *
 * Compiled: 2013-08-06
 *
 * GrapeFruit Debug Plugin is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license.php
 */
!function(window){var document=window.document;gf.plugin.register({},"debug"),gf.debug.version="0.0.1",gf.debug.gfVersion="0.0.x",gf.debug.onTick=function(){this._super(),gf.debug._statsTick(),gf.debug.panels&&(gf.debug.panels.map.tick(),gf.debug.panels.performance.tick(),gf.debug.panels.sprites.tick())},gf.debug.show=function(game){if(!(game&&game instanceof gf.Game))throw"Please pass a game instance to gf.debug.show!";if(this.game)throw"Already debugging a game instance!";this.game=game,this.panels={map:new gf.debug.MapPanel(game),sprites:new gf.debug.SpritesPanel(game),gamepad:new gf.debug.GamepadPanel(game),performance:new gf.debug.PerformancePanel(game)},gf.plugin.patch(gf.Game,"_tick",this.onTick),this.logObjectCountEvent=!1,document.body.appendChild(this._createElement()),this._bindEvents()},gf.debug.logEvent=function(name){this.panels&&this.panels.performance&&this.panels.performance.logEvent(name)},gf.debug._bindEvents=function(){var activePanel,self=this;this.ui.bindDelegate(this._bar,"click","gf_debug_menu_item",function(e){var panel=self.panels[e.target.className.replace(/gf_debug_menu_item|active/g,"").trim()];if(panel){if(activePanel&&(activePanel.toggle(),self.ui.removeClass(activePanel._menuItem,"active"),activePanel.name===panel.name))return activePanel=null,void 0;"performance"===panel.name?panel.active=!0:self.panels.performance.active=!1,self.ui.addClass(e.target,"active"),panel.toggle(),activePanel=panel}})},gf.debug._createElement=function(){var c=this._container=document.createElement("div"),bar=this._bar=document.createElement("div");this.ui.addClass(c,"gf_debug"),c.appendChild(bar),this.ui.addClass(bar,"gf_debug_menu"),bar.appendChild(this._createMenuHead()),bar.appendChild(this._createMenuStats());for(var p in this.panels)bar.appendChild(this.panels[p].createMenuElement()),c.appendChild(this.panels[p].createPanelElement());return c},gf.debug._createMenuHead=function(){var div=document.createElement("div");return this.ui.addClass(div,"gf_debug_head"),this.ui.setText(div,"Gf Debug ("+this.game.renderMethod+"):"),div},gf.debug._createMenuStats=function(){this._stats={};var div=document.createElement("div"),fps=this._stats.fps=document.createElement("div"),ms=this._stats.ms=document.createElement("div"),obj=this._stats.obj=document.createElement("div");return this.ui.addClass(div,"gf_debug_stats"),this.ui.addClass(ms,"gf_debug_stats_item ms"),this.ui.setHtml(ms,"<span>0</span> ms"),div.appendChild(ms),this.ui.addClass(fps,"gf_debug_stats_item fps"),this.ui.setHtml(fps,"<span>0</span> fps"),div.appendChild(fps),this.ui.addClass(obj,"gf_debug_stats_item obj"),this.ui.setHtml(obj,"<span>0</span> objects"),div.appendChild(obj),div},gf.debug._statsTick=function(){var ms=this.game.timings.tickEnd-this.game.timings.tickStart,fps=1e3/ms;fps=fps>60?60:fps,this.ui.setText(this._stats.ms.firstElementChild,ms.toFixed(2)),this.ui.setText(this._stats.fps.firstElementChild,fps.toFixed(2))},setInterval(function(){if(gf.debug._stats&&gf.debug._stats.obj){for(var c=0,s=gf.debug.game.activeState,wld=s.world,cam=s.camera;wld;)c++,wld=wld._iNext;for(;cam;)c++,cam=cam._iNext;gf.debug.ui.setText(gf.debug._stats.obj.firstElementChild,c),gf.debug.logObjectCountEvent&&gf.debug.logEvent("debug_count_objects")}},2e3),gf.debug.Panel=function(game){this.game=game,this.name="",this.title=""},gf.inherits(gf.debug.Panel,Object,{createPanelElement:function(){var div=this._panel=document.createElement("div");return gf.debug.ui.addClass(div,"gf_debug_panel"),gf.debug.ui.addClass(div,this.name),div},createMenuElement:function(){var div=this._menuItem=document.createElement("div");return gf.debug.ui.addClass(div,"gf_debug_menu_item "+this.name),gf.debug.ui.setText(div,this.title),div},toggle:function(){"block"===this._panel.style.display?this.hide():this.show()},show:function(){gf.debug.ui.setStyle(this._panel,"display","block")},hide:function(){gf.debug.ui.setStyle(this._panel,"display","none")}}),gf.debug.GamepadPanel=function(game){gf.debug.Panel.call(this,game),this.name="gamepad",this.title="Gamepad",this.gamepad=new gf.debug.Gamepad,this.bindEvents()},gf.inherits(gf.debug.GamepadPanel,gf.debug.Panel,{createPanelElement:function(){var div=gf.debug.Panel.prototype.createPanelElement.call(this);return div.appendChild(this.gamepad.element),window.console.log(this.gamepad.element),div},bindEvents:function(){var game=this.game,pad=this.gamepad;game.input.gamepad.buttons.on(gf.input.GP_BUTTON.FACE_1,pad.updateButton.bind(pad)),game.input.gamepad.buttons.on(gf.input.GP_BUTTON.FACE_2,pad.updateButton.bind(pad)),game.input.gamepad.buttons.on(gf.input.GP_BUTTON.FACE_3,pad.updateButton.bind(pad)),game.input.gamepad.buttons.on(gf.input.GP_BUTTON.FACE_4,pad.updateButton.bind(pad)),game.input.gamepad.buttons.on(gf.input.GP_BUTTON.LEFT_SHOULDER,pad.updateButton.bind(pad)),game.input.gamepad.buttons.on(gf.input.GP_BUTTON.RIGHT_SHOULDER,pad.updateButton.bind(pad)),game.input.gamepad.buttons.on(gf.input.GP_BUTTON.LEFT_TRIGGER,pad.updateButton.bind(pad)),game.input.gamepad.buttons.on(gf.input.GP_BUTTON.RIGHT_TRIGGER,pad.updateButton.bind(pad)),game.input.gamepad.buttons.on(gf.input.GP_BUTTON.SELECT,pad.updateButton.bind(pad)),game.input.gamepad.buttons.on(gf.input.GP_BUTTON.START,pad.updateButton.bind(pad)),game.input.gamepad.buttons.on(gf.input.GP_BUTTON.LEFT_ANALOGUE_STICK,pad.updateButton.bind(pad)),game.input.gamepad.buttons.on(gf.input.GP_BUTTON.RIGHT_ANALOGUE_STICK,pad.updateButton.bind(pad)),game.input.gamepad.buttons.on(gf.input.GP_BUTTON.PAD_TOP,pad.updateButton.bind(pad)),game.input.gamepad.buttons.on(gf.input.GP_BUTTON.PAD_BOTTOM,pad.updateButton.bind(pad)),game.input.gamepad.buttons.on(gf.input.GP_BUTTON.PAD_LEFT,pad.updateButton.bind(pad)),game.input.gamepad.buttons.on(gf.input.GP_BUTTON.PAD_RIGHT,pad.updateButton.bind(pad)),game.input.gamepad.sticks.on(gf.input.GP_AXIS.LEFT_ANALOGUE_HOR,pad.updateAxis.bind(pad)),game.input.gamepad.sticks.on(gf.input.GP_AXIS.LEFT_ANALOGUE_VERT,pad.updateAxis.bind(pad)),game.input.gamepad.sticks.on(gf.input.GP_AXIS.RIGHT_ANALOGUE_HOR,pad.updateAxis.bind(pad)),game.input.gamepad.sticks.on(gf.input.GP_AXIS.RIGHT_ANALOGUE_VERT,pad.updateAxis.bind(pad))}}),gf.debug.PerformancePanel=function(game){gf.debug.Panel.call(this,game),this.name="performance",this.title="Performance",this.eventQueue=[],this.active=!1},gf.inherits(gf.debug.PerformancePanel,gf.debug.Panel,{createPanelElement:function(){var div=gf.debug.Panel.prototype.createPanelElement.call(this);return this.graph=new gf.debug.Graph(div,window.innerWidth-10,245,{input:"rgba(80, 220, 80, 1)",camera:"rgba(80, 80, 220, 1)",phys:"rgba(80, 220, 200, 1)",draw:"rgba(220, 80, 80, 1)",event:"rgba(200, 200, 200, 0.6)"}),this.graph.max=50,div},tick:function(){if(this.active){var t=this.game.timings,o={input:t.inputEnd-t.inputStart,camera:t.cameraEnd-t.cameraStart,phys:t.physicsEnd-t.physicsStart,draw:t.renderEnd-t.renderStart},evt=this.eventQueue.shift();evt&&(o.event=evt),this.graph.addData(o)}},logEvent:function(name){this.eventQueue.push(name)}}),gf.debug.SpritesPanel=function(game){gf.debug.Panel.call(this,game),this.name="sprites",this.title="Sprites",this.gfx=new PIXI.Graphics,this.style={_default:{size:1,color:16720418,alpha:1},sensor:{size:1,color:2293538,alpha:1}}},gf.inherits(gf.debug.SpritesPanel,gf.debug.Panel,{createPanelElement:function(){var div=gf.debug.Panel.prototype.createPanelElement.call(this),pad=document.createElement("div"),col=document.createElement("div");return gf.debug.ui.addClass(col,"checkbox"),gf.debug.ui.setHtml(col,'<input type="checkbox" value="None" id="gf_debug_toggleCollisions" class="gf_debug_toggleCollisions" name="check" /><label for="gf_debug_toggleCollisions"></label><span>Show sprite colliders</span>'),gf.debug.ui.bindDelegate(col,"click","gf_debug_toggleCollisions",this.toggleCollisions.bind(this),"input"),pad.appendChild(col),div.appendChild(pad),div},toggleCollisions:function(){this.showing=!this.showing,this.showing?(this.game.world.addChild(this.gfx),this._drawPhysics()):this.gfx.parent&&this.gfx.parent.removeChild(this.gfx)},tick:function(){this.showing&&this._drawPhysics()},_drawPhysics:function(){var self=this,g=this.gfx;this.gfx.clear(),this.game.physics.space.eachShape(function(shape){if(shape.body){var body=shape.body,p=body.p,style=shape.sensor?self.style.sensor:self.style._default;if(g.lineStyle(style.size,style.color,style.alpha),"circle"===shape.type){var cx=shape.bb_l+(shape.bb_r-shape.bb_l)/2,cy=shape.bb_t+(shape.bb_b-shape.bb_t)/2;g.drawCircle(cx,cy,shape.r)}else{var sx=shape.verts[0],sy=shape.verts[1];g.moveTo(p.x+sx,p.y+sy);for(var i=2;i<shape.verts.length;i+=2)g.lineTo(p.x+shape.verts[i],p.y+shape.verts[i+1]);g.lineTo(p.x+sx,p.y+sy)}}})}}),gf.debug.MapPanel=function(game){gf.debug.Panel.call(this,game),this.name="map",this.title="Mini-Map"},gf.inherits(gf.debug.MapPanel,gf.debug.Panel,{createPanelElement:function(){var div=gf.debug.Panel.prototype.createPanelElement.call(this);return this.minimap=new gf.debug.Minimap(div,this.game),div},tick:function(){this.minimap.render()}}),gf.debug.Graph=function(container,width,height,dataStyles){this.canvas=document.createElement("canvas"),this.canvas.width=width,this.canvas.height=height,container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.dataCanvases=[document.createElement("canvas"),document.createElement("canvas")],this.dataCtxs=[this.dataCanvases[0].getContext("2d"),this.dataCanvases[1].getContext("2d")],this.dataScroll=[0,0],this.dataIndex=0,this.label="ms",this.labelPrecision=0,this.labelStyle="rgba(200, 200, 200, 0.6)",this.max=50,this.dataLineWidth=1,this.padding=5,this.keySize=115,this.dataCanvases[0].width=this.dataCanvases[1].width=width-this.keySize,this.dataCanvases[0].height=this.dataCanvases[1].height=height,this.data=[],this.styles=dataStyles||{},this.styles._default||(this.styles._default="red"),this.styles.event||(this.styles.event="gray")},gf.inherits(gf.debug.Graph,Object,{addData:function(values){this.data.push(values),this.data.length>(this.canvas.width-this.keySize)/this.dataLineWidth&&this.data.shift(),this.render()},render:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.updateData(),this.drawBg(),this.drawKey(),this.drawData()},drawBg:function(){var ctx=this.ctx,minX=this.keySize,maxX=this.canvas.width,maxY=this.canvas.height,step=maxY/3;ctx.strokeStyle=ctx.fillStyle=this.labelStyle,ctx.beginPath(),ctx.moveTo(minX,step),ctx.lineTo(maxX,step),ctx.stroke(),ctx.beginPath(),ctx.moveTo(minX,2*step),ctx.lineTo(maxX,2*step),ctx.stroke(),ctx.beginPath(),ctx.moveTo(minX,maxY),ctx.lineTo(maxX,maxY),ctx.stroke(),ctx.fillText((2*(this.max/3)).toFixed(this.labelPrecision)+this.label,minX+this.padding,step-this.padding),ctx.fillText((this.max/3).toFixed(this.labelPrecision)+this.label,minX+this.padding,2*step-this.padding)},drawKey:function(){var ctx=this.ctx,i=0,box=10,data=this.data[this.data.length-1],pad=this.padding,lbl=this.labelStyle;for(var k in this.styles){var style=this.styles[k],y=box*i+pad*(i+1),val="number"==typeof data[k]?data[k].toFixed(2):null,text=k+(val?" ("+val+" ms)":"");ctx.fillStyle=style,ctx.fillRect(pad,y,box,box),ctx.fillStyle=lbl,ctx.fillText(text,pad+box+pad,y+box),i++}},drawData:function(){var i=this.dataIndex,ni=this.dataIndex?0:1,c1=this.dataCanvases[i],s1=this.dataScroll[i],c2=this.dataCanvases[ni],s2=this.dataScroll[ni],w=c1.width,h=c1.height;this.ctx.drawImage(c1,0,0,s1,h,w-s1+this.keySize,0,s1,h),this.ctx.drawImage(c2,s2-w,0,w-(s2-w),h,this.keySize,0,w-(s2-w),h),w===s1&&(this.dataScroll[ni]=this.dataLineWidth,this.dataCtxs[ni].clearRect(0,0,w,h),this.dataIndex=ni)},updateData:function(){var ctx=this.dataCtxs[this.dataIndex],x=this.dataScroll[this.dataIndex],maxY=this.dataCanvases[this.dataIndex].height,lw=this.dataLineWidth,vals=this.data[this.data.length-1],v=0,step=0,y=maxY;for(var k in vals)ctx.beginPath(),ctx.strokeStyle=ctx.fillStyle=this.styles[k]||this.styles._default,ctx.lineWidth=lw,v=vals[k],"event"===k?(ctx.moveTo(x,maxY),ctx.lineTo(x,0),ctx.fillText(v,x+this.padding,2*this.padding)):(step=v/this.max*maxY,step=0>step?0:step,ctx.moveTo(x,y),ctx.lineTo(x,y-=step)),ctx.stroke();this.dataScroll[0]+=lw,this.dataScroll[1]+=lw}}),gf.debug.Minimap=function(container,game){this.canvas=document.createElement("canvas"),this.prerenderCanvas=document.createElement("canvas"),container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.pctx=this.prerenderCanvas.getContext("2d"),this.cachedpos=new gf.Point,this.mapimage=null,this.game=game,this.scale=.25,this.viewportRectColor="rgba(255, 0, 255, 1)"},gf.inherits(gf.debug.Minimap,Object,{render:function(){if(this.game.world){var world=this.game.world;this.cachedworld&&this.cachedworld===world||(this.cachedworld=world,this.canvas.width=this.prerenderCanvas.width=world.size.x*world.tileSize.x*this.scale,this.canvas.height=this.prerenderCanvas.height=world.size.y*world.tileSize.y*this.scale,this.prerender()),this.cachedpos&&this.cachedpos.x===world.position.x&&this.cachedpos===world.position.y||(this.cachedpos.x=world.position.x,this.cachedpos.y=world.position.y,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawMap())}},drawMap:function(){this.ctx.drawImage(this.prerenderCanvas,0,0);var w=this.game.world,p=w.position,c=this.game.camera,s=this.scale;this.ctx.strokeStyle=this.viewportRectColor,this.ctx.strokeRect(-p.x*s/w.scale.x,-p.y*s/w.scale.x,c.size.x*s/w.scale.x,c.size.y*s/w.scale.y)},prerender:function(){for(var world=this.game.world,size=world.size,tsx=world.tileSize.x*this.scale,tsy=world.tileSize.y*this.scale,l=0,ll=world.children.length;ll>l;++l){var layer=world.children[l];if(layer.tileIds&&layer.visible)for(var x=0,xl=size.x;xl>x;++x)for(var y=0,yl=size.y;yl>y;++y){var tx,id=x+y*size.x,tid=layer.tileIds[id],set=world.getTileset(tid);set&&(tx=set.getTileTexture(tid),this.prerenderTile(tx,x*tsx,y*tsy))}}},prerenderTile:function(tile,x,y){var frame=tile.frame;this.pctx.drawImage(tile.baseTexture.source,frame.x,frame.y,frame.width,frame.height,x,y,frame.width*this.scale,frame.height*this.scale)}});var STICK_OFFSET=10,btnIds=["button-1","button-2","button-3","button-4","button-left-shoulder-top","button-right-shoulder-top","button-left-shoulder-bottom","button-right-shoulder-bottom","button-select","button-start","stick-1","stick-2","button-dpad-top","button-dpad-bottom","button-dpad-left","button-dpad-right"],axisIds=[["stick-1-axis-x","stick-1"],["stick-1-axis-y","stick-1"],["stick-2-axis-x","stick-2"],["stick-2-axis-y","stick-2"]],template='<div class="gf_debug_gp_buttons"><div class="gf_debug_gp_face" name="button-1"></div><div class="gf_debug_gp_face" name="button-2"></div><div class="gf_debug_gp_face" name="button-3"></div><div class="gf_debug_gp_face" name="button-4"></div><div class="gf_debug_gp_top-shoulder" name="button-left-shoulder-top"></div><div class="gf_debug_gp_top-shoulder" name="button-right-shoulder-top"></div><div class="gf_debug_gp_bottom-shoulder" name="button-left-shoulder-bottom"></div><div class="gf_debug_gp_bottom-shoulder" name="button-right-shoulder-bottom"></div><div class="gf_debug_gp_select-start" name="button-select"></div><div class="gf_debug_gp_select-start" name="button-start"></div><div class="gf_debug_gp_stick" name="stick-1"></div><div class="gf_debug_gp_stick" name="stick-2"></div><div class="gf_debug_gp_face" name="button-dpad-top"></div><div class="gf_debug_gp_face" name="button-dpad-bottom"></div><div class="gf_debug_gp_face" name="button-dpad-left"></div><div class="gf_debug_gp_face" name="button-dpad-right"></div></div><div class="gf_debug_gp_labels"><label for="button-1">?</label><label for="button-2">?</label><label for="button-3">?</label><label for="button-4">?</label><label for="button-left-shoulder-top">?</label><label for="button-right-shoulder-top">?</label><label for="button-left-shoulder-bottom">?</label><label for="button-right-shoulder-bottom">?</label><label for="button-select">?</label><label for="button-start">?</label><label for="stick-1">?</label><label for="stick-2">?</label><label for="button-dpad-top">?</label><label for="button-dpad-bottom">?</label><label for="button-dpad-left">?</label><label for="button-dpad-right">?</label><label for="stick-1-axis-x">?</label><label for="stick-1-axis-y">?</label><label for="stick-2-axis-x">?</label><label for="stick-2-axis-y">?</label></div><div class="gf_debug_gp_name">Grapefruit</div>';gf.debug.Gamepad=function(){var el=this.element=document.createElement("div");el.classList.add("gf_debug_gp"),el.innerHTML=template},gf.inherits(gf.debug.Gamepad,Object,{updateButton:function(status){var buttonEl=this.element.querySelector('[name="'+btnIds[status.code]+'"]'),labelEl=this.element.querySelector('label[for="'+btnIds[status.code]+'"]');labelEl.innerHTML=status.value.toFixed(2),status.down?(buttonEl.classList.add("pressed"),labelEl.classList.add("visible")):(buttonEl.classList.remove("pressed"),labelEl.classList.remove("visible"))},updateAxis:function(status){var stickEl=this.element.querySelector('[name="'+axisIds[status.code][1]+'"]'),labelEl=this.element.querySelector('label[for="'+axisIds[status.code][0]+'"]'),offsetVal=status.value*STICK_OFFSET;status.code===gf.input.GP_AXIS.LEFT_ANALOGUE_HOR||status.code===gf.input.GP_AXIS.RIGHT_ANALOGUE_HOR?stickEl.style.marginLeft=offsetVal+"px":stickEl.style.marginTop=offsetVal+"px",labelEl.innerHTML=status.value.toFixed(2),0!==status.value?(labelEl.classList.add("visible"),status.value>0?labelEl.classList.add("positive"):labelEl.classList.add("negative")):(labelEl.classList.remove("visible"),labelEl.classList.remove("positive"),labelEl.classList.remove("negative"))}}),gf.debug.ui={bindDelegate:function(dom,evt,cls,fn,name){name=name?name.toUpperCase():"DIV",dom.addEventListener(evt,function(e){if(e.target&&e.target.nodeName.toUpperCase()===name){var classes=e.target.className.split(" ");classes&&-1!==classes.indexOf(cls)&&fn&&fn(e)}})},removeClass:function(dom,cls){var classes=dom.className.split(" "),i=classes.indexOf(cls);-1!==i&&(classes.splice(i,1),dom.className=classes.join(" ").trim())},addClass:function(dom,cls){var classes=dom.className.split(" ");classes.push(cls),dom.className=classes.join(" ").trim()},setText:function(dom,txt){dom.textContent=txt},setHtml:function(dom,html){dom.innerHTML=html},setStyle:function(dom,style,value){if("string"==typeof style)dom.style[style]=value;else for(var key in style)dom.style[key]=style[key]}}}(window);