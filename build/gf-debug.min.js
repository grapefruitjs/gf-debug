/**
 * @license
 * GrapeFruit Debug Plugin - v0.0.1
 * Copyright (c) 2013, Chad Engler
 * https://github.com/grapefruitjs/gf-debug
 *
 * Compiled: 2013-07-29
 *
 * GrapeFruit Debug Plugin is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license.php
 */
!function(window){var document=window.document,d={version:"0.0.1",gfVersion:"0.0.x"};gf.plugin.register(d,"debug"),gf.debug.show=function(game){if(!(game&&game instanceof gf.Game))throw"Please pass a game instance to gf.debug.show!";if(this.game)throw"Already debugging a game instance!";this.game=game,this.game.on("beforetick",this._beforeTick.bind(this)),this.game.on("aftertick",this._afterTick.bind(this)),this.panels={world:new gf.debug.WorldPanel(game),sprites:new gf.debug.SpritesPanel(game),physics:new gf.debug.PhysicsPanel(game),gamepad:new gf.debug.GamepadPanel(game),perf:new gf.debug.PerformancePanel(game)},document.body.appendChild(this.createElement()),this.bindEvents()},gf.debug.logEvent=function(name){this.panels&&this.panels.perf&&this.panels.perf.logEvent(name)},gf.debug.bindEvents=function(){var activeMenuItem;this.ui.bindDelegate(this._bar,"click","gf_debug_menu_item",function(e){activeMenuItem&&this.ui.removeClass(activeMenuItem,"active"),this.ui.addClass(e.target,"active"),activeMenuItem=e.target})},gf.debug.createElement=function(){var c=this._container=document.createElement("div"),bar=this._bar=document.createElement("div");this.ui.addClass(c,"gf_debug"),c.appendChild(bar),this.ui.addClass(bar,"gf_debug_menu"),bar.appendChild(this.createMenuHead()),bar.appendChild(this.createMenuStats());for(var p in this.panels)bar.appendChild(this.panels[p].createMenuElement()),c.appendChild(this.panels[p].createPanelElement());return c},gf.debug.createMenuHead=function(){var div=document.createElement("div");return this.ui.addClass(div,"gf_debug_menu_item gf_debug_head"),this.ui.setText(div,"Gf Debug:"),div},gf.debug.createMenuStats=function(){this._stats={};var div=document.createElement("div"),fps=this._stats.fps=document.createElement("div"),ms=this._stats.ms=document.createElement("div"),spr=this._stats.spr=document.createElement("div");return this.ui.addClass(div,"gf_debug_menu_item gf_debug_stats"),this.ui.addClass(ms,"gf_debug_stats_item ms"),this.ui.setHtml(ms,"<span>0</span> ms"),div.appendChild(ms),this.ui.addClass(fps,"gf_debug_stats_item fps"),this.ui.setHtml(fps,"<span>0</span> fps"),div.appendChild(fps),this.ui.addClass(spr,"gf_debug_stats_item spr"),this.ui.setHtml(spr,"<span>0</span> sprites"),div.appendChild(spr),div},gf.debug.timer=window.performance&&window.performance.now?window.performance:Date,gf.debug._beforeTick=function(){this._tickStart=this.timer.now()},gf.debug._afterTick=function(){this.statsTick(),this.panels.perf.tick(),this.panels.gamepad.tick()},gf.debug.statsTick=function(){this._tickEnd=this.timer.now();var ms=this._tickEnd-this._tickStart,fps=1e3/ms;fps=fps>60?60:fps,this.ui.setText(this._stats.ms.firstElementChild,ms.toFixed(2)),this.ui.setText(this._stats.fps.firstElementChild,fps.toFixed(2))},setInterval(function(){if(gf.debug._stats&&gf.debug._stats.spr){for(var c=0,s=gf.debug.game.activeState,wld=s.world,cam=s.camera;wld;)c++,wld=wld._iNext;for(;cam;)c++,cam=cam._iNext;gf.debug.ui.setText(gf.debug._stats.spr.firstElementChild,c),gf.debug.logSpriteCount&&gf.debug.logEvent("debug_count_sprites")}},1e3),gf.debug.Panel=function(game){this.game=game,this.name="",this.title=""},gf.inherits(gf.debug.Panel,Object,{createPanelElement:function(){var div=this._panel=document.createElement("div");return gf.debug.ui.addClass(div,"gf_debug_panel"),div},createMenuElement:function(){var div=this._menuItem=document.createElement("div");return gf.debug.ui.addClass(div,"gf_debug_menu_item "+this.name),gf.debug.ui.setText(div,this.title),div.addEventListener("click",this.toggle.bind(this),!1),div},toggle:function(){"block"===this._panel.style.display?this.hide():this.show()},show:function(){gf.debug.ui.setStyle(this._panel,"display","block")},hide:function(){gf.debug.ui.setStyle(this._panel,"display","none")}}),gf.debug.GamepadPanel=function(game){gf.debug.Panel.call(this,game),this.name="gamepad"},gf.inherits(gf.debug.GamepadPanel,gf.debug.Panel,{createPanelElement:function(){var div=gf.debug.Panel.prototype.createPanelElement.call(this);return gf.debug.ui.setText(div,this.name),div},tick:function(){}}),gf.debug.PerformancePanel=function(game){gf.debug.Panel.call(this,game),this.name="performance",this.title="Performance",this.eventQueue=[]},gf.inherits(gf.debug.PerformancePanel,gf.debug.Panel,{createPanelElement:function(){var div=gf.debug.Panel.prototype.createPanelElement.call(this);return gf.debug.ui.setText(div,this.name),this.graph=new gf.debug.Graph(div,1500,200,{input:"rgb(80, 80, 80)",camera:"rgb(80, 80, 220)",physics:"rgb(80, 220, 80)",render:"rgb(220, 80, 80)",event:"rgba(200, 200, 200, 0.6)"}),div},tick:function(){var t=this.game.timings,o={input:t.inputEnd-t.inputStart,camera:t.cameraEnd-t.cameraStart,phys:t.physicsEnd-t.physicsStart,render:t.renderEnd-t.renderStart},evt=this.eventQueue.shift();evt&&(o.event=evt),this.graph.addData(o)},logEvent:function(name){this.eventQueue.push(name)}}),gf.debug.PhysicsPanel=function(game){gf.debug.Panel.call(this,game),this.name="physics"},gf.inherits(gf.debug.PhysicsPanel,gf.debug.Panel,{createPanelElement:function(){var div=gf.debug.Panel.prototype.createPanelElement.call(this);return gf.debug.ui.setText(div,this.name),div}}),gf.debug.SpritesPanel=function(game){gf.debug.Panel.call(this,game),this.name="sprites"},gf.inherits(gf.debug.SpritesPanel,gf.debug.Panel,{createPanelElement:function(){var div=gf.debug.Panel.prototype.createPanelElement.call(this);return gf.debug.ui.setText(div,this.name),div}}),gf.debug.WorldPanel=function(game){gf.debug.Panel.call(this,game),this.name="world"},gf.inherits(gf.debug.WorldPanel,gf.debug.Panel,{createPanelElement:function(){var div=gf.debug.Panel.prototype.createPanelElement.call(this);return gf.debug.ui.setText(div,this.name),div}}),gf.debug.Graph=function(container,width,height,dataStyles){this.canvas=document.createElement("canvas"),this.canvas.width=width,this.canvas.height=height,container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.label="ms",this.labelPrecision=0,this.labelStyle="rgba(200, 200, 200, 0.6)",this.max=50,this.dataLineWidth=1,this.padding=5,this.data=[],this.styles=dataStyles||{},this.styles._default||(this.styles._default="red"),this.styles.event||(this.styles.event="gray")},gf.inherits(gf.debug.Graph,Object,{addData:function(values){this.data.push(values),this.data.length>this.canvas.width/this.dataLineWidth&&this.data.shift(),this.redraw()},redraw:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawBg(),this.drawData()},drawBg:function(){var ctx=this.ctx,maxX=this.canvas.width,maxY=this.canvas.height,step=maxY/3;ctx.strokeStyle=ctx.fillStyle=this.labelStyle,ctx.beginPath(),ctx.moveTo(0,step),ctx.lineTo(maxX,step),ctx.stroke(),ctx.beginPath(),ctx.moveTo(0,2*step),ctx.lineTo(maxX,2*step),ctx.stroke(),ctx.beginPath(),ctx.moveTo(0,maxY),ctx.lineTo(maxX,maxY),ctx.stroke(),ctx.fillText((2*(this.max/3)).toFixed(this.labelPrecision)+this.label,this.padding,step-this.padding),ctx.fillText((this.max/3).toFixed(this.labelPrecision)+this.label,this.padding,2*step-this.padding)},drawData:function(){for(var ctx=this.ctx,maxX=this.canvas.width,maxY=this.canvas.height,lw=this.dataLineWidth,len=this.data.length,i=len-1;i>-1;--i){var vals=this.data[i],x1=maxX-(len-i)*lw,x2=x1-lw,y=maxY;for(var k in vals){var v=vals[k];if("event"===k)ctx.fillStyle=this.styles.event,ctx.fillRect(x1,0,x2,maxY),ctx.fillText(v,x1+2,this.padding);else{var step=maxY-v/this.max*maxY;ctx.fillStyle=this.styles[k]||this.styles._default,console.log(x1,y,x2,y-step),ctx.fillRect(x1,y,x2,y-=step)}}}}}),gf.debug.ui={bindDelegate:function(dom,evt,cls,fn){dom.addEventListener(evt,function(e){if(e.target&&"div"===e.target.nodeName){var classes=e.target.className.trim().split(" ");classes&&-1!==classes.indexOf(cls)&&fn&&fn(e)}})},removeClass:function(dom,cls){var classes=dom.className.trim().split(" "),i=classes.indexOf(cls);-1!==i&&(classes.splice(i,1),dom.className=classes.join(" "))},addClass:function(dom,cls){var classes=dom.className.trim().split(" ");classes.push(cls),dom.className+=classes.join(" ")},setText:function(dom,txt){dom.textContent=txt},setHtml:function(dom,html){dom.innerHTML=html},setStyle:function(dom,style,value){if("string"==typeof style)dom.style[style]=value;else for(var key in style)dom.style[key]=style[key]}}}(window);